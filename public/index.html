let hasJoined = false;

async function loadInitialData() {
  showLoading();
  const doc = await attendanceRef.get();
  if (!doc.exists) {
    await attendanceRef.set({ 
      count: 0, 
      maxCapacity: 300,
      date: '2024-01-13',
      time: '14:00'
    });
  }
  hideLoading();
}

attendanceRef.onSnapshot((doc) => {
  if (doc.exists) {
    const data = doc.data();
    count = data.count || 0;
    MAX_CAPACITY = data.maxCapacity || 300;

    const lastResetTimestamp = localStorage.getItem('lastResetTimestamp');
    const newResetTimestamp = data.resetTimestamp?.toDate();
    if (newResetTimestamp && (!lastResetTimestamp || newResetTimestamp > new Date(lastResetTimestamp))) {
      localStorage.removeItem('hasJoined');
      localStorage.setItem('lastResetTimestamp', newResetTimestamp.toISOString());
      hasJoined = false;
    } else {
      hasJoined = localStorage.getItem('hasJoined') === 'true';
    }

    document.getElementById('mainTitle').textContent = data.mainTitle || '신불산 프로젝트';
    if (data.date && data.time) {
      document.getElementById('dateInfo').textContent = `${formatDate(data.date)} ${formatTime(data.time)}`;
    }
    updateDisplay();
  }
});

function updateDisplay() {
  const counter = document.getElementById('counter');
  const joinBtn = document.getElementById('joinBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const statusMessage = document.getElementById('statusMessage');
  const myStatus = document.getElementById('myStatus');
  const capacityInfo = document.getElementById('capacityInfo');

  counter.innerText = count;
  capacityInfo.textContent = `최대 수용 인원: ${MAX_CAPACITY}명`;
  
  joinBtn.disabled = hasJoined || count >= MAX_CAPACITY;
  cancelBtn.disabled = !hasJoined;
  
  console.log('UI 갱신:', { hasJoined, count, MAX_CAPACITY, joinBtnDisabled: joinBtn.disabled });

  if (count >= MAX_CAPACITY) {
    statusMessage.textContent = '정원이 마감되었습니다';
    statusMessage.style.color = '#e74c3c';
  } else if (count === 0) {
    statusMessage.textContent = '참가자를 기다리고 있습니다';
    statusMessage.style.color = '#666';
  } else {
    statusMessage.textContent = `남은 자리: ${MAX_CAPACITY - count}명`;
    statusMessage.style.color = '#2ecc71';
  }

  myStatus.textContent = hasJoined ? '✅ 참가 신청 완료' : '미참가 상태';
  myStatus.style.color = hasJoined ? '#2ecc71' : '#666';
}

loadInitialData();